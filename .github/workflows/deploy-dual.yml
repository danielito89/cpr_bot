name: Deploy to Lightsail (Tokyo) & Orange Pi (Lab)

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # ---------------------------------------------------
      # 1. DESPLIEGUE A PRODUCCIÓN (Lightsail Tokyo)
      # ---------------------------------------------------
      - name: Deploy to AWS Lightsail
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.LIGHTSAIL_HOST }}     # IP Nueva de Tokyo
          username: ${{ secrets.USER_LIGHTSAIL }} # 'ubuntu'
          key: ${{ secrets.SSH_PRIVATE_KEY }}     # Tu llave .pem
          script: |
            # Entrar a la carpeta
            cd /home/ubuntu/bot_cpr
            
            # Bajar cambios
            git fetch --all
            git reset --hard origin/main
            
            # Actualizar librerías (por si agregamos algo nuevo)
            source venv/bin/activate
            
            # Reiniciar el bot para aplicar cambios
            sudo systemctl restart cpr_dashboard
            sudo systemctl restart cpr_bot_breakout
            sudo systemctl restart cpr_telegram
            echo "✅ Producción actualizada y reiniciada."

      # ---------------------------------------------------
      # 2. DESPLIEGUE A LABORATORIO (Orange Pi vía Tailscale)
      # ---------------------------------------------------
      - name: Setup Tailscale
        uses: tailscale/github-action@v3
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}
          version: latest

      - name: Deploy to Orange Pi
        uses: appleboy/ssh-action@master
        continue-on-error: true  # Si la Orange Pi está apagada, no fallar el deploy
        with:
          host: ${{ secrets.ORANGEPI_HOST }} # IP 100.x.x.x de Tailscale
          username: ${{ secrets.USER_ORANGEPI }} # Tu usuario (ej. 'orangepi')
          key: ${{ secrets.ORANGEPI_SSH_KEY }}
          script: |
            # Solo actualizamos código para backtesting (no reiniciamos servicios)
            cd /home/orangepi/bot_cpr
            git fetch --all
            git reset --hard origin/main
            echo "✅ Laboratorio actualizado."
