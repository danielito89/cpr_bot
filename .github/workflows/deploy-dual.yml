name: Deploy to Hetzner (Germany) & Orange Pi (Lab)

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # ---------------------------------------------------
      # 1. DESPLIEGUE A PRODUCCIÃ“N (Hetzner Alemania - Docker)
      # ---------------------------------------------------
      
      # Paso A: Copiar todos los archivos del repositorio al VPS
      # Esto reemplaza al 'git fetch'. Es mÃ¡s seguro y no requiere configurar Git en el server.
      - name: Copy files to Hetzner Germany
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST_GERMANY }}
          username: ${{ secrets.USER_GERMANY }}
          key: ${{ secrets.SSH_KEY_GERMANY }}
          port: 22
          source: "."
          target: "/root/cpr_bot"
          rm: false # Â¡MUY IMPORTANTE! False para NO borrar tu archivo .env del servidor

      # Paso B: Ejecutar comandos Docker (Construir y Levantar)
      # Esto reemplaza al 'source venv' y 'systemctl restart'. Docker se encarga de todo.
      - name: Start Bot via Docker
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST_GERMANY }}
          username: ${{ secrets.USER_GERMANY }}
          key: ${{ secrets.SSH_KEY_GERMANY }}
          port: 22
          script: |
            echo "ðŸš€ Iniciando despliegue en Alemania..."
            
            # 1. Ir a la carpeta
            cd /root/cpr_bot
            
            # 2. Bajar el bot actual (si estÃ¡ corriendo)
            docker compose down
            
            # 3. Construir nueva imagen (instala librerÃ­as nuevas si hay) y levantar
            # --build: Fuerza a leer el Dockerfile y requirements.txt de nuevo
            docker compose up -d --build
            
            # 4. Limpieza: Borrar imÃ¡genes viejas para no llenar el disco del VPS
            docker image prune -f
            
            echo "âœ… ProducciÃ³n Alemania actualizada y corriendo."

      # ---------------------------------------------------
      # 2. DESPLIEGUE A LABORATORIO (Orange Pi vÃ­a Tailscale)
      # ---------------------------------------------------
      # Esta parte queda igual que antes (Git pull sin Docker por ahora)
      - name: Setup Tailscale
        uses: tailscale/github-action@v3
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}
          version: latest

      - name: Deploy to Orange Pi
        uses: appleboy/ssh-action@master
        continue-on-error: true  # Si la Orange Pi estÃ¡ apagada, no falla el deploy principal
        with:
          host: ${{ secrets.ORANGEPI_HOST }}
          username: ${{ secrets.USER_ORANGEPI }}
          key: ${{ secrets.ORANGEPI_SSH_KEY }}
          script: |
            echo "ðŸ§ª Actualizando laboratorio..."
            cd /home/orangepi/bot_cpr
            git fetch --all
            git reset --hard origin/main
            echo "âœ… Laboratorio actualizado (CÃ³digo sincronizado)."